#
# Apache configuration files and keys.
#
files:
  /etc/httpd/conf.d/00_elastic_beanstalk_proxy.conf:
    mode: '000644'
    owner: root
    group: root
    content: |
      Mutex posixsem
      SSLSessionCache "shmcb:logs/ssl_scache(512000)"

      Listen 8080

      <VirtualHost *:8080>
        <IfModule !deflate_module>
          LoadModule deflate_module /etc/httpd/modules/mod_deflate.so
        </IfModule>
        <IfModule !headers_module>
           LoadModule headers_module /etc/httpd/modules/mod_headers.so
        </IfModule>

        <Directory /opt/python/current/app/boac/static>
          Order allow,deny
          Allow from all
          Require all granted
        </Directory>

        DocumentRoot /opt/python/current/app/boac/static

        Header set Access-Control-Allow-Origin "*"

        RewriteEngine on

        RewriteCond %{QUERY_STRING} transport=polling
        RewriteRule /(.*)$ http://localhost:5000/$1 [P]

        # Proxy
        ProxyPass         /          http://localhost:5000 retry=0
        ProxyPreserveHost On

        # We will forward HTTPS requests
        # RequestHeader set X-Forwarded-Proto "https"

        # GZIP all responses using mod_deflate
        SetOutputFilter DEFLATE
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE application/json
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript

        # Aggressively cache static assets
        <LocationMatch "^/boac/static">
          ExpiresActive On
          ExpiresDefault "access plus 1 year"
        </LocationMatch>
      </VirtualHost>
