<div class="container">
  <div data-ng-include="'/static/app/shared/header.html'"></div>

  <div data-ng-if="isLoading && !error">
    <h1 class="faint-text">Loading....</h1>
  </div>
  <div data-ng-if="isSaving && !error">
    <h1 class="faint-text">Saving....</h1>
  </div>
  <div data-ng-if="error">
    <h1>Error</h1>
    <div>
      Sorry, there was an error retrieving cohort data.
      <span class="faint-text" data-ng-if="error.message">(<span data-ng-bind="error.message"></span>)</span>
    </div>
  </div>
  <div class="cohort-label" data-ng-if="!isLoading && !error && !isSaving && (cohort.totalMemberCount >= 0)">
    <h1 data-ng-if="!isCreateCohortMode && cohort.code">
      <span data-ng-bind="cohort.name"></span>
      <span class="faint-text">(<span data-ng-bind="cohort.totalMemberCount"></span> members)</span>
    </h1>
    <h1 data-ng-if="!cohort.code && !isLoading && !isCreateCohortMode">
      <span data-ng-pluralize count="cohort.totalMemberCount" when="{'one': '1 Result', 'other': '{} Results'}"></span>
    </h1>
  </div>
  <div class="cohort-column-results" data-ng-if="!isLoading && !error && !isSaving && isCreateCohortMode">
    <h1>
      Create a Cohort
    </h1>
    <div>
      Find a set of users then save your search as a custom cohort. Revisit your saved cohorts at any time.
    </div>
  </div>

  <hr class="filters-section-separator" data-ng-if="!isLoading && !error && !isCreateCohortMode"/>

  <!-- Teams -->
  <div class="flex-container flex-space-between" data-ng-if="!error">
    <div class="cohort-filters-column flex-column-btn">
      <div class="btn-group box-shadow-off"
           uib-dropdown
           auto-close="disabled"
           is-open="search.dropdown.groupCodesOpen"
           keyboard-nav>
        <!-- Dropdown docs at https://angular-ui.github.io/bootstrap/ -->
        <button id="search-filter-teams"
                type="button"
                class="btn cohort-filter-dropdown-toggle"
                uib-dropdown-toggle>
          <span class="cohort-filter-label">
            Teams
            <span data-ng-if="!isLoading && !isSaving">(<span data-ng-bind="search.count.teamGroups"></span>)</span>
            <i class="fa fa-chevron-down"
               data-ng-if="!isLoading && !isSaving && !search.dropdown.groupCodesOpen"></i>
            <i class="fa fa-chevron-up"
               data-ng-if="!isLoading && !isSaving && search.dropdown.groupCodesOpen"></i>
            <i class="fa fa-spinner fa-spin"
               aria-hidden="true"
               data-ng-if="isLoading || isSaving"></i>
          </span>
        </button>
        <ul aria-labelledby="search-filter-teams"
            class="cohort-filter-list dropdown-menu"
            role="menu"
            uib-dropdown-menu
            data-ng-if="!isLoading && !isSaving">
          <li class="cohort-filter-list-item"
              role="menuitem"
              data-ng-repeat="teamGroup in search.options.teamGroups">
            <input id="search-option-team-{{teamGroup.groupCode}}"
                   type="checkbox"
                   data-ng-model="teamGroup.selected"
                   aria-label="{{teamGroup.groupName}}"
                   data-ng-click="updateSelected('teamGroups', teamGroup)"/>
            <span data-ng-bind="teamGroup.groupName"></span></li>
        </ul>
      </div>
    </div>
    <!-- Class levels -->
    <div class="cohort-filters-column flex-column-btn">
      <div class="btn-group box-shadow-off"
           uib-dropdown
           auto-close="disabled"
           is-open="search.dropdown.levelsOpen"
           keyboard-nav>
        <button id="search-filter-level"
                type="button"
                class="btn cohort-filter-dropdown-toggle"
                uib-dropdown-toggle>
          <span class="cohort-filter-label">
            Levels
            <span data-ng-if="!isLoading && !isSaving">(<span data-ng-bind="search.count.levels"></span>)</span>
            <i class="fa fa-chevron-down"
               data-ng-if="!isLoading && !isSaving && !search.dropdown.levelsOpen"></i>
            <i class="fa fa-chevron-up"
               data-ng-if="!isLoading && !isSaving && search.dropdown.levelsOpen"></i>
            <i class="fa fa-spinner fa-spin"
               aria-hidden="true"
               data-ng-if="isLoading || isSaving"></i>
          </span>
        </button>
        <ul aria-labelledby="search-filter-level"
            class="cohort-filter-list dropdown-menu"
            role="menu"
            uib-dropdown-menu
            data-ng-if="!isLoading && !isSaving">
          <li class="cohort-filter-list-item"
              role="menuitem"
              data-ng-repeat="level in search.options.levels">
            <input id="search-option-level-{{level.name}}"
                   type="checkbox"
                   data-ng-model="level.selected"
                   aria-label="{{level.name}}"
                   data-ng-click="updateSelected('levels', level)"/>
            <span data-ng-bind="level.name"></span></li>
        </ul>
      </div>
    </div>
    <!-- Majors -->
    <div class="cohort-filters-column flex-column-btn">
      <div class="btn-group box-shadow-off"
           uib-dropdown
           auto-close="disabled"
           is-open="search.dropdown.majorsOpen"
           keyboard-nav>
        <button id="search-filter-majors"
                type="button"
                class="btn cohort-filter-dropdown-toggle"
                uib-dropdown-toggle>
          <span class="cohort-filter-label">
            Majors
            <span data-ng-if="!isLoading && !isSaving">(<span data-ng-bind="search.count.majors"></span>)</span>
            <i class="fa fa-chevron-down"
               data-ng-if="!isLoading && !isSaving && !search.dropdown.majorsOpen"></i>
            <i class="fa fa-chevron-up"
               data-ng-if="!isLoading && !isSaving && search.dropdown.majorsOpen"></i>
            <i class="fa fa-spinner fa-spin"
               aria-hidden="true"
               data-ng-if="isLoading || isSaving"></i>
          </span>
        </button>
        <ul aria-labelledby="search-filter-majors"
            class="cohort-filter-list dropdown-menu"
            role="menu"
            uib-dropdown-menu
            data-ng-if="!isLoading && !isSaving">
          <li class="cohort-filter-list-item"
              role="menuitem"
              data-ng-repeat="major in search.options.majors">
            <input id="search-option-major-{{major.name}}"
                   type="checkbox"
                   data-ng-model="major.selected"
                   aria-label="{{major.name}}"
                   data-ng-click="updateSelected('majors', major)"/>
            <span data-ng-bind="major.name"></span></li>
        </ul>
      </div>
    </div>
    <!-- GPA -->
    <div class="cohort-filters-column flex-column-btn">
      <div class="btn-group box-shadow-off"
           uib-dropdown
           auto-close="disabled"
           is-open="search.dropdown.gpaRangesOpen"
           keyboard-nav>
        <button id="search-filter-gpa-ranges"
                type="button"
                class="btn cohort-filter-dropdown-toggle"
                uib-dropdown-toggle>
          <span class="cohort-filter-label">
            GPA
            <span data-ng-if="!isLoading && !isSaving">(<span data-ng-bind="search.count.gpaRanges"></span>)</span>
            <i class="fa fa-chevron-down"
               data-ng-if="!isLoading && !isSaving && !search.dropdown.gpaRangesOpen"></i>
            <i class="fa fa-chevron-up"
               data-ng-if="!isLoading && !isSaving && search.dropdown.gpaRangesOpen"></i>
            <i class="fa fa-spinner fa-spin"
               aria-hidden="true"
               data-ng-if="isLoading || isSaving"></i>
          </span>
        </button>
        <ul aria-labelledby="search-filter-gpa-ranges"
            class="cohort-filter-list dropdown-menu"
            role="menu"
            uib-dropdown-menu
            data-ng-if="!isLoading && !isSaving">
          <li class="cohort-filter-list-item"
              role="menuitem"
              data-ng-repeat="gpaRange in search.options.gpaRanges">
            <input id="search-option-gpa-range-{{$index}}"
                   type="checkbox"
                   data-ng-model="gpaRange.selected"
                   aria-label="{{gpaRange.name}}"
                   data-ng-click="updateSelected('gpaRanges', gpaRange)"/>
            <span data-ng-bind="gpaRange.name"></span></li>
        </ul>
      </div>
    </div>
    <!-- Units -->
    <div class="cohort-filters-column flex-column-btn">
      <div class="btn-group box-shadow-off"
           uib-dropdown
           auto-close="disabled"
           is-open="search.dropdown.unitRangesOpen"
           keyboard-nav>
        <button id="search-filter-unit-ranges"
                type="button"
                class="btn cohort-filter-dropdown-toggle"
                uib-dropdown-toggle>
          <span class="cohort-filter-label">
            Units
            <span data-ng-if="!isLoading && !isSaving">(<span data-ng-bind="search.count.unitRanges"></span>)</span>
            <i class="fa fa-chevron-down"
               data-ng-if="!isLoading && !isSaving && !search.dropdown.unitRangesOpen"></i>
            <i class="fa fa-chevron-up"
               data-ng-if="!isLoading && !isSaving && search.dropdown.unitRangesOpen"></i>
            <i class="fa fa-spinner fa-spin"
               aria-hidden="true"
               data-ng-if="isLoading || isSaving"></i>
          </span>
        </button>
        <ul aria-labelledby="search-filter-unit-ranges"
            class="cohort-filter-list dropdown-menu"
            role="menu"
            uib-dropdown-menu
            data-ng-if="!isLoading && !isSaving">
          <!-- Pacing units -->
          <li class="cohort-filter-list-section-label" role="menuitem">Pacing (Total)</li>
          <li class="cohort-filter-list-item"
            role="menuitem"
            data-ng-repeat="unitRange in search.options.unitRangesPacing">
          <input id="search-option-unit-range-pacing-{{$index}}"
                 type="checkbox"
                 data-ng-model="unitRange.selected"
                 aria-label="{{unitRange.name}}"
                 data-ng-click="updateSelected('unitRanges', unitRange)"/>
          <span data-ng-bind="unitRange.name"></span></li>
          <!-- Eligibility units -->
          <li class="divider"></li>
          <li class="cohort-filter-list-section-label" role="menuitem">Eligibility (Per Term/Year)</li>
          <li class="cohort-filter-list-item"
              role="menuitem"
              data-ng-repeat="unitRange in search.options.unitRangesEligibility">
            <input id="search-option-unit-range-eligibility-{{$index}}"
                   type="checkbox"
                   data-ng-model="unitRange.selected"
                   aria-label="{{unitRange.name}}"
                   data-ng-click="updateSelected('unitRanges', unitRange)"/>
            <span data-ng-bind="unitRange.name"></span></li>
        </ul>
      </div>
    </div>
    <!-- Search and save buttons -->
    <div class="cohort-filters-column flex-column-10"></div>
    <div class="cohort-filters-column flex-column-btn">
      <button id="execute-search"
              class="btn btn-primary btn-nowrap"
              data-ng-disabled="(!search.count.gpaRanges &&
                                 !search.count.teamGroups &&
                                 !search.count.levels &&
                                 !search.count.majors &&
                                 !search.count.unitRangesEligibility &&
                                 !search.count.unitRangesPacing) || isLoading || isSaving"
              data-ng-click="executeSearch()">Search</button>
    </div>
    <div class="cohort-filters-column flex-column-btn">
      <span data-ng-controller="CreateCohortController">
        <button id="create-cohort-btn"
                class="btn btn-default btn-nowrap"
                data-ng-disabled="(!search.count.gpaRanges &&
                                   !search.count.teamGroups &&
                                   !search.count.levels &&
                                   !search.count.majors &&
                                   !search.count.unitRangesEligibility &&
                                   !search.count.unitRangesPacing) || isLoading || isSaving"
                data-ng-click="openCreateCohortModal(search.options)">
          Save Cohort
        </button>
      </span>
    </div>
  </div>

  <hr class="filters-section-separator" data-ng-if="!isLoading && !error && !isCreateCohortMode && cohort.totalMemberCount"/>

  <div class="cohort-column-results">
    <div class="flex-container flex-space-between"
         data-ng-if="!isLoading && !error && cohort.totalMemberCount">
      <div class="cohort-sort-column">
        <div class="btn-group cohort-btn-group" role="group" aria-label="Select results view">
          <button type="button"
                  class="btn btn-secondary cohort-tab-button"
                  data-ng-class="{'cohort-tab-button-selected': tabs.selected==='list'}"
                  data-ng-click="onTab('list')"
                  data-ng-disabled="isSaving">
            <i class="fa fa-list"></i> List
          </button>
          <button type="button"
                  class="btn btn-secondary cohort-tab-button"
                  data-ng-class="{'cohort-tab-button-selected': tabs.selected==='matrix'}"
                  data-ng-disabled="isSaving"
                  data-ng-click="onTab('matrix')">
            <i class="fa fa-table"></i> Matrix
          </button>
        </div>
      </div>
      <div class="cohort-sort-column" data-ng-if="tabs.selected === 'list'">
        <label class="cohort-sort-label" for="cohort-sort-by">Sort by</label>
        <select id="cohort-sort-by"
                class="form-control"
                data-ng-model="orderBy.selected"
                data-ng-options="o.value as o.label for o in orderBy.options">
        </select>
      </div>
    </div>
    <div data-ng-show="tabs.selected === 'list'"
         data-ng-if="!isLoading && !error && cohort.totalMemberCount">
      <ul id="cohort-members-list" class="list-group">
        <a class="list-group-item cohort-member-list-item"
           data-ng-href="/student/{{student.uid}}"
           data-ng-repeat="student in cohort.members">
          <div class="cohort-avatar-container">
            <img class="cohort-avatar"
                 data-ng-src="/api/user/{{student.uid}}/photo"
                 data-avatar-fallback>
          </div>
          <div class="cohort-member-name-container">
            <h3 class="cohort-member-name" data-ng-bind="student.firstName + ' ' + student.lastName"></h3>
            <div class="cohort-member-sid" data-ng-bind="student.sid"></div>
            <div class="cohort-member-text" data-ng-bind="student.level"></div>
            <div class="cohort-member-text" data-ng-bind="major" data-ng-repeat="major in student.majors"></div>
          </div>
          <div class="cohort-member-column">
            <div class="cohort-member-gpa" data-ng-bind="student.cumulativeGPA || '--'"></div>
            <div class="cohort-member-text">GPA (Cumulative)</div>
          </div>
          <div class="cohort-member-column">
            <div class="cohort-member-gpa" data-ng-bind="student.currentTerm.enrolledUnits || '0'"></div>
            <div class="cohort-member-text">Units (In Progress)</div>
            <div class="cohort-member-gpa" data-ng-bind="student.cumulativeUnits || '--'"></div>
            <div class="cohort-member-text">Total Units</div>
          </div>
          <div class="cohort-member-course-activity-wrapper">
            <div class="cohort-member-course-activity-row">
              <div class="cohort-member-column cohort-member-text">CLASSES</div>
              <div class="cohort-member-column cohort-member-text">PAGE VIEWS</div>
            </div>
            <div class="cohort-member-course-activity-row" data-ng-repeat="enrollment in student.currentTerm.enrollments">
              <div class="cohort-member-column">
                <div data-ng-bind="enrollment.displayName"></div>
              </div>
              <div class="cohort-member-column">
                <div class="cohort-boxplot-container" data-ng-repeat="canvasSite in enrollment.canvasSites">
                  <div id="boxplot-{{canvasSite.canvasCourseId}}-{{student.uid}}-pageviews"
                       class="cohort-boxplot">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </a>
      </ul>
      <ul uib-pagination
          direction-links="false"
          items-per-page="pagination.itemsPerPage"
          total-items="cohort.totalMemberCount"
          ng-model="pagination.currentPage"
          data-ng-click="nextPage()"
          data-ng-if="pagination.enabled && !isCreateCohortMode && (cohort.totalMemberCount > pagination.itemsPerPage)"></ul>
    </div>
    <div id="cohort-matrix-container" class="cohort-matrix-container" data-ng-show="tabs.selected === 'matrix' && !isLoading && !error">
      <!-- IMPORTANT: We use data-ng-show because d3 must populate the div before we reveal it to the user. -->
      <div id="scatterplot" class="cohort-matrix"></div>
      <div id="cohort-missing-student-data" class="cohort-missing-student-data" data-ng-if="studentsWithoutData.length">
        <h4>Missing Student Data</h4>
        <div>For the following students, some classes may only provide partial data or no information is available:</div>
        <div class="cohort-missing-student-data-header">
          <div class="cohort-avatar-container"></div>
          <div class="cohort-member-name-container"></div>
          <div class="cohort-member-column">Page Views</div>
          <div class="cohort-member-column"
               data-ng-bind="yAxisMeasure==='analytics.courseCurrentScore' ? 'Assignment Grades' : 'Assignments on Time'"></div>
        </div>
        <ul class="list-group">
          <a class="list-group-item cohort-member-list-item"
             data-ng-href="/student/{{student.uid}}"
             data-ng-repeat="student in studentsWithoutData">
            <div class="cohort-avatar-container">
              <img class="cohort-avatar"
                   data-ng-src="/api/user/{{student.uid}}/photo"
                   data-avatar-fallback>
            </div>
            <div class="cohort-member-name-container">
              <h3 class="cohort-member-name" data-ng-bind="student.firstName + ' ' + student.lastName"></h3>
              <div class="cohort-member-sid">
                SID: <span data-ng-bind="student.sid"></span>
              </div>
            </div>
            <div class="cohort-member-column">
              <span data-ng-bind-template="{{student.analytics.pageViews | number:1}}%" data-ng-if="student.analytics.pageViews"></span>
            </div>
            <div class="cohort-member-column" data-ng-if="yAxisMeasure==='analytics.courseCurrentScore'">
              <span data-ng-bind-template="{{student.analytics.courseCurrentScore | number:1}}%" data-ng-if="student.analytics.courseCurrentScore"></span>
            </div>
            <div class="cohort-member-column" data-ng-if="yAxisMeasure!=='analytics.courseCurrentScore'">
              <span data-ng-bind-template="{{student.analytics.assignmentsOnTime | number:1}}%" data-ng-if="student.analytics.assignmentsOnTime"></span>
            </div>
          </a>
        </ul>
      </div>
    </div>
  </div>

  <div data-ng-include="'/static/app/shared/footer.html'"></div>
</div>
